
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
        <link rel="next" href="QUICKSTART/">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>Ephemeral PR environments using vCluster</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ephemeral-pr-environment-using-vcluster" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Ephemeral PR environments using vCluster" class="md-header__button md-logo" aria-label="Ephemeral PR environments using vCluster" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ephemeral PR environments using vCluster
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LoftLabs-Experiments/workshop-ephemeral-PR" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    LoftLabs-Experiments/workshop-ephemeral-PR
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Ephemeral PR environments using vCluster" class="md-nav__button md-logo" aria-label="Ephemeral PR environments using vCluster" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ephemeral PR environments using vCluster
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LoftLabs-Experiments/workshop-ephemeral-PR" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    LoftLabs-Experiments/workshop-ephemeral-PR
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-vcluster" class="md-nav__link">
    <span class="md-ellipsis">
      What is vCluster?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-ephemeral-pr-environments" class="md-nav__link">
    <span class="md-ellipsis">
      Why Ephemeral PR Environments?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites:
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Kubernetes cluster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-ingress-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying Ingress controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-the-kubernetes-cluster-to-the-platform" class="md-nav__link">
    <span class="md-ellipsis">
      Connect the Kubernetes cluster to the platform
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-application" class="md-nav__link">
    <span class="md-ellipsis">
      Demo Application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Demo Application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-setting-up-the-deployment-template" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Setting Up the Deployment Template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-automating-with-github-actions" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Automating with GitHub Actions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-cleanup-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Cleanup Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      How It Works
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How It Works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Cleanup:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="QUICKSTART/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-vcluster" class="md-nav__link">
    <span class="md-ellipsis">
      What is vCluster?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-ephemeral-pr-environments" class="md-nav__link">
    <span class="md-ellipsis">
      Why Ephemeral PR Environments?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites:
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites:">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Kubernetes cluster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-ingress-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying Ingress controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-the-kubernetes-cluster-to-the-platform" class="md-nav__link">
    <span class="md-ellipsis">
      Connect the Kubernetes cluster to the platform
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-application" class="md-nav__link">
    <span class="md-ellipsis">
      Demo Application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Demo Application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-setting-up-the-deployment-template" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Setting Up the Deployment Template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-automating-with-github-actions" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Automating with GitHub Actions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-cleanup-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Cleanup Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      How It Works
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How It Works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Cleanup:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ephemeral-pr-environment-using-vcluster">Ephemeral PR environment using vCluster</h1>
<p>In a fast-paced development environment, having an isolated and ephemeral environment to test changes for every pull request (PR) is a game-changer. In this blog, I’ll walk you through setting up ephemeral PR environments using vCluster, enabling seamless testing of your application in a Kubernetes environment. We'll also leverage GitHub Actions for automation, ensuring every labeled PR dynamically creates a vCluster, deploys the application, and cleans up upon merging or label removal.</p>
<p>Let’s dive into the step-by-step guide.</p>
<h2 id="what-is-vcluster">What is vCluster?</h2>
<p>vCluster is a technology that allows you to create lightweight, isolated Kubernetes clusters within a host cluster. These virtual clusters offer full Kubernetes functionality while being resource-efficient, making them ideal for scenarios like PR testing environments.</p>
<h2 id="why-ephemeral-pr-environments">Why Ephemeral PR Environments?</h2>
<p>Ephemeral environments allow:</p>
<ul>
<li>Testing pull request changes in an isolated environment</li>
<li>Quick validation without interfering with the main cluster</li>
<li>Automatic cleanup post-testing
By leveraging vCluster and GitHub Actions, you can automate this workflow and ensure every PR gets its own dedicated environment.</li>
</ul>
<h2 id="prerequisites">Prerequisites:</h2>
<h3 id="kubernetes-cluster">Kubernetes cluster</h3>
<p>You need to have a Kubernetes cluster, in this case I am using a DigitalOcean Kubernetes cluster but any should work. I am creating a realistic production scenario so for that I used a cluster that can create service type: LoadBalancer. </p>
<p>Command:
<code>kubectl get nodes</code></p>
<pre><code>kubectl get nodes
NAME              STATUS   ROLES    AGE   VERSION
live-demo-e0is0   Ready    &lt;none&gt;   19d   v1.31.1
live-demo-e0is1   Ready    &lt;none&gt;   19d   v1.31.1
live-demo-e0isz   Ready    &lt;none&gt;   19d   v1.31.1
</code></pre>
<h3 id="deploying-ingress-controller">Deploying Ingress controller</h3>
<p>Command</p>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/cloud/deploy.yaml

</code></pre>
<p>Output</p>
<pre><code>kubectl get po,svc -n ingress-nginx
NAME                                           READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-admission-create-lcb85       0/1     Completed   0          19d
pod/ingress-nginx-admission-patch-xl2fk        0/1     Completed   0          19d
pod/ingress-nginx-controller-79fcc99b4-7f7ls   1/1     Running     0          19d
</code></pre>
<p>Getting the LoadBalancer IP for the ingress controller:</p>
<p>Command:
<code>kubectl get svc -n ingress-nginx</code>
Output:</p>
<pre><code>NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.109.28.126   209.38.160.229   80:31228/TCP,443:30435/TCP   19d
service/ingress-nginx-controller-admission   ClusterIP      10.109.15.162   &lt;none&gt;           443/TCP                      19d

</code></pre>
<p>Domain mapping:</p>
<p>For our application we need dynamic ingress for testing so what we have done here is added the loadbalancer IP of the ingress controller as the A record to the Domain. </p>
<p><img alt="" src="images/domain.webp" /></p>
<h3 id="connect-the-kubernetes-cluster-to-the-platform">Connect the Kubernetes cluster to the platform</h3>
<p>We will enable vCluster Pro in order to use templates and create the clusters.  For simplicity, I am using my vcluster.cloud account and then creating the access key to login. In this way I don’t have to run any agent on the current cluster. You can either run vcluster platform start or sign up on vCluster cloud  and once you login, you should be able to go to access keys and create a short lived access key for the demo (remember to delete the key post demo for security reasons). </p>
<p>Command:</p>
<pre><code>vcluster platform login https://saiyam.vcluster.cloud --access-key &lt;your-access-key&gt;
</code></pre>
<p>Output:</p>
<p><img alt="" src="images/vcluster_login.webp" />
<img alt="" src="images/access_key.webp" />
Create a template under vCluster templates in the vCluster cloud platform instance.</p>
<pre><code>sync:
  fromHost:
    ingressClasses:
      enabled: true
  toHost:
    ingresses:
      enabled: true
external:
  platform:
    autoSleep:
      afterInactivity: 3600  # Automatically sleep after 1 hour of inactivity
</code></pre>
<p>Until now we have a Kubernetes cluster with ingress controller installed and the Public IP of the nginx controller pointed to our domain. </p>
<p>We also have logged into the platform using the access keys created using vcluster.cloud. Now let’s see the demo application that we have. </p>
<h2 id="demo-application">Demo Application</h2>
<p><img alt="" src="images/workshop2.png" />
<img alt="" src="images/secrets.png" />
The scenario we are trying to achieve here involves a sample application deployed onto a Kubernetes cluster. Often, in organizations, new features or bug fixes need to be deployed and tested before being merged into the main branch. In this case, a developer raises a pull request and adds a label to test it. Based on GitHub Actions, the application is built, and then a deployment, service, and ingress Kubernetes object file are generated and pushed to a new branch. A virtual cluster is created, and the new deployment file is applied, allowing the developer to test and verify the new application deployment. </p>
<p>Let’s see how this looks in practice. 
<a href="https://github.com/LoftLabs-Experiments/workshop-ephemeral-PR">GitHub repo</a>
The application for this demo is a simple Go-based HTTP server:</p>
<pre><code>package main

import (
    &quot;embed&quot;
    &quot;html/template&quot;
    &quot;net/http&quot;
)

//go:embed templates/*
var templatesFS embed.FS

//go:embed static/*
var staticFS embed.FS

func handler(w http.ResponseWriter, r *http.Request) {
    tmpl := template.Must(template.ParseFS(templatesFS, &quot;templates/index.html&quot;))
    data := struct{ Title string }{Title: &quot;Welcome to the Multi-Tenancy March Series Powered by Loft Labs&quot;}
    tmpl.Execute(w, data)
}

func main() {
    http.HandleFunc(&quot;/&quot;, handler)
    http.Handle(&quot;/static/&quot;, http.FileServer(http.FS(staticFS)))
    http.ListenAndServe(&quot;:8080&quot;, nil)
}

</code></pre>
<h3 id="step-1-setting-up-the-deployment-template">Step 1: Setting Up the Deployment Template</h3>
<p>The application is packaged as a Kubernetes deployment and exposed via a service and ingress. The deployment uses Jinja2 templating to inject dynamic values like the image tag and ingress host.</p>
<p>tmpl/deploy.j2:</p>
<pre><code>kind: Deployment
metadata:
  name: workshop-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workshop-app
  template:
    metadata:
      labels:
        app: workshop-app
    spec:
      containers:
      - name: workshop-app
        image: {{ image_deploy_tag }}
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: workshop-service
spec:
  selector:
    app: workshop-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
  namespace: default
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  ingressClassName: nginx
  rules:
  - host: {{ ingress_tag }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: workshop-service
            port:
              number: 80
</code></pre>
<h3 id="step-2-automating-with-github-actions">Step 2: Automating with GitHub Actions</h3>
<p>GitHub Actions handles the workflow from building the application to deploying it on a vCluster.</p>
<p>PR Workflow
File: .github/workflows/build-and-deploy.yml This workflow:</p>
<ul>
<li>Builds the application with the latest changes made by the developer using ko</li>
<li>Pushes the container image to docker hub account(credentials for which should be set in the Actions secret as described previously)</li>
<li>Creates a deployment manifest using Jinja2 - The action will replace the ingress host and the deployment image variables mentioned in the jinja template and then push to a new feature branch.</li>
<li>Creates a vCluster.</li>
<li>Deploys the application to the vCluster.</li>
<li>Exposes it via ingress for testing.</li>
</ul>
<pre><code>name: Build and Deploy with vCluster

on:
  pull_request:
    types: [labeled]

jobs:
  build-and-deploy:
    if: ${{ github.event.label.name == 'test' }}
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the PR Code
      - name: Checkout PR Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # Step 2: Set up Go
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'  # Matches your Dockerfile's golang:1.21-alpine

      # Step 3: Initialize Go Module
      - name: Initialize Go Module
        working-directory: app
        run: |
          go mod init github.com/loftlabs-experiments/workshop-ephemeral-pr || echo &quot;Module already initialized&quot;
          go mod tidy

      # Step 4: Set up ko
      - name: Set up ko
        uses: ko-build/setup-ko@v0.6
        with:
          version: v0.14.1

      # Step 5: Log into GHCR
      - name: Log into GHCR
        run: |
          echo &quot;${{ secrets.GITHUB_TOKEN }}&quot; | ko login ghcr.io --username ${{ github.actor }} --password-stdin

      # Step 6: Build and Push Image with ko
      - name: Build and Push Image
        working-directory: app
        env:
          KO_DOCKER_REPO: ghcr.io/loftlabs-experiments/workshop-ephemeral-pr
          KO_DEFAULT_PLATFORM: linux/amd64
        run: |
          export IMAGE_TAG=sha-$(git rev-parse --short HEAD)
          ko build . -t $IMAGE_TAG -t latest
          echo &quot;image_deploy_tag=ghcr.io/loftlabs-experiments/workshop-ephemeral-pr:$IMAGE_TAG&quot; &gt;&gt; $GITHUB_ENV

      # Step 7: Generate Deployment Manifest
      - name: Generate Deployment Manifest
        uses: cuchi/jinja2-action@v1.1.0
        with:
          template: tmpl/deploy.j2
          output_file: deploy/deployment.yaml
          strict: true
          variables: |
            image_deploy_tag=${{ env.image_deploy_tag }}
            ingress_tag=pr${{ github.event.pull_request.number }}.vcluster.tech

      # Step 8: Push to a Feature Branch
      - name: Push Deployment Manifest
        run: |
          git config --global user.email &quot;github-actions[bot]@users.noreply.github.com&quot;
          git config --global user.name &quot;github-actions[bot]&quot;
          git checkout -b feature-test-${{ github.event.pull_request.head.sha }}
          git add deploy/deployment.yaml
          git commit -m &quot;Adding deployment.yaml for PR-${{ github.event.pull_request.number }}&quot; || echo &quot;No changes to commit&quot;
          git push origin feature-test-${{ github.event.pull_request.head.sha }} --force

      # Step 9: Install vCluster CLI
      - name: Install vCluster CLI
        uses: loft-sh/setup-vcluster@main
        with:
          url: ${{ secrets.VCLUSTER_PLATFORM_URL }}
          access-key: ${{ secrets.VCLUSTER_ACCESS_KEY }}

      # Step 10: Create vCluster
      - name: Create A vCluster
        uses: loft-sh/create-vcluster@main
        with:
          name: pr-${{ github.event.pull_request.number }}
          project: default
          template: my-template
          parameters: |
            - name: ingress_link
              value: &quot;http://pr${{ github.event.pull_request.number }}.vcluster.tech&quot;

      # Step 11: Deploy to vCluster
      - name: Deploy Application to vCluster
        run: |
          kubectl apply -Rf deploy/

      # Step 12: Test Application with curl
      - name: Test Application
        run: |
          sleep 10  # Wait for the application to be ready
          curl --retry 5 --retry-delay 10 http://pr${{ github.event.pull_request.number }}.vcluster.tech
</code></pre>
<h3 id="step-3-cleanup-workflow">Step 3: Cleanup Workflow</h3>
<p>Once the PR is merged or the label is removed, the ephemeral vCluster is deleted.</p>
<p>File: .github/workflows/cleanup.yml</p>
<pre><code>name: Clean Up vCluster

on:
  pull_request:
    types: [closed, unlabeled]

jobs:
  cleanup:
    if: (github.event.action == 'closed' &amp;&amp; github.event.pull_request.merged == true) || (github.event.action == 'unlabeled' &amp;&amp; github.event.label.name == 'test')
    runs-on: ubuntu-latest

    steps:
      # Step 1: Install vCluster CLI
      - name: Install vCluster CLI
        uses: loft-sh/setup-vcluster@main
        with:
          url: ${{ secrets.VCLUSTER_PLATFORM_URL }}
          access-key: ${{ secrets.VCLUSTER_ACCESS_KEY }}

      # Step 2: Delete vCluster
      - name: Delete vCluster
        env:
          NAME: pr-${{ github.event.pull_request.number }}
        run: |
          vcluster platform delete vcluster $NAME --project default --force || echo &quot;vCluster $NAME not found or already deleted&quot;
</code></pre>
<h2 id="how-it-works">How It Works</h2>
<p>A developer creates a PR to do the feature changes.
<img alt="" src="images/pr1.webp" />
With a small change the developer has raised a PR and now needs to add a test  label.</p>
<p><img alt="" src="images/pr2.webp" />
As soon as the label is added the GitHub actions kicks off
<img alt="" src="images/pr3.webp" /></p>
<p>In the vCluster platform cloud instance you will be able to see the cluster getting created and the application will be deployed. 
<img alt="" src="images/platform.webp" />
<img alt="" src="images/actions.webp" />
The Action is completed and pr14.vcluster.tech is created as part of ingress.</p>
<p>The application is accessible at <code>http://pr&lt;PR_NUMBER&gt;.vcluster.tech</code>.</p>
<p>As you can see  the latest changes made by the developer are deployed. </p>
<p><img alt="" src="images/output.webp" /></p>
<h3 id="cleanup">Cleanup:</h3>
<p>Upon PR merge or label removal, the ephemeral vCluster is automatically deleted.
<img alt="" src="images/cleanup.webp" /></p>
<p>After merging, the cleanup action is triggered, which will clear the virtual cluster.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Ephemeral PR environments using vCluster simplify testing, reduce resource usage, and provide a seamless developer experience. By combining vCluster with GitHub Actions, you can achieve an automated and efficient workflow for testing PRs.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>